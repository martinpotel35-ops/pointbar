<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üç∏ PointBar ‚Äì On se retrouve √† mi-chemin</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg1:#0a0f1a; --bg2:#111b2b; --panel:#162237;
      --accent:#f6c55c; --text:#eef2f6; --muted:#98a3b4;
      --line: rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);overflow:hidden}
    h1,h2,h3,p{margin:0}
    a{color:var(--accent);text-decoration:none}
    button{cursor:pointer;font-weight:600;border:none;border-radius:12px;padding:12px 16px;font-size:15px;transition:all .2s}
    button.primary{background:var(--accent);color:#141920}
    button.secondary{background:#1e2c45;color:var(--text)}
    button.ghost{background:transparent;border:1px dashed var(--line);color:var(--muted)}
    button:active{transform:scale(.98)}
    header{position:fixed;top:0;left:0;width:100%;height:58px;background:rgba(15,22,35,.8);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:1000;border-bottom:1px solid rgba(255,255,255,.05)}
    header h1{font-size:20px;letter-spacing:.3px;display:flex;align-items:center;gap:6px}
    main{display:flex;flex-direction:column;height:100%;padding-top:58px}
    #map{flex:1;min-height:45%;z-index:1}
    .panel{background:rgba(22,32,50,.85);backdrop-filter:blur(10px);border-top-left-radius:20px;border-top-right-radius:20px;padding:14px 14px 84px;position:relative;z-index:2;overflow-y:auto;max-height:55%}
    .inputs{display:flex;flex-direction:column;gap:10px;margin-bottom:10px}
    input{padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1724;color:var(--text);font-size:15px;width:100%}
    .filters{display:flex;overflow-x:auto;gap:8px;margin:10px 0;padding-bottom:6px}
    .filter{padding:6px 12px;border-radius:999px;background:#1c283e;color:var(--muted);font-size:14px;white-space:nowrap;border:1px solid var(--line);transition:.2s}
    .filter.active{background:var(--accent);color:#141920}
    .results{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .card{background:#0f1724;border-radius:16px;padding:12px;border:1px solid var(--line);box-shadow:0 2px 6px rgba(0,0,0,.35)}
    .card h3{font-size:16px;font-weight:700;margin-bottom:4px}
    .card small{color:var(--muted)}
    .badge{display:inline-block;border-radius:8px;border:1px solid var(--line);padding:2px 8px;font-size:12px;margin-left:8px}
    .ok{color:#6ef0b3}.warn{color:#f0d46e}
    .row{display:flex;gap:8px;align-items:center}
    .nav{position:fixed;bottom:0;left:0;width:100%;height:64px;background:rgba(15,22,35,.85);backdrop-filter:blur(10px);display:flex;justify-content:space-around;align-items:center;border-top:1px solid rgba(255,255,255,.05)}
    .nav button{background:none;color:var(--muted);font-size:13px;display:flex;flex-direction:column;align-items:center;gap:2px;border-radius:8px;padding:6px 8px}
    .nav button.active{color:var(--accent)}
    .status{color:var(--muted);font-size:14px;margin:6px 0}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,15,26,.2);backdrop-filter:blur(2px);z-index:2000}
    .overlay.show{display:flex}
    .spinner{width:44px;height:44px;border-radius:50%;border:4px solid #2a3553;border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(min-width:900px){
      main{flex-direction:row}
      #map{flex:2;min-height:100%}
      .panel{flex:1;max-height:none;border-radius:0;border-left:1px solid rgba(255,255,255,.05)}
      .nav{display:none}
    }
  </style>
</head>
<body>
  <header><h1>üç∏ PointBar</h1></header>

  <main>
    <div id="map"></div>

    <div class="panel">
      <div class="inputs">
        <input id="addr1" placeholder="Adresse 1 (ex : Bastille, Paris)" />
        <input id="addr2" placeholder="Adresse 2 (ex : R√©publique, Paris)" />
        <input id="addr3" placeholder="Adresse 3 (optionnel)" />
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button id="useGPS" class="ghost">üìç Utiliser ma position</button>
          <button id="find" class="primary">Trouver des bars √©quitables</button>
        </div>
        <div id="status" class="status"></div>
      </div>

      <div class="filters" id="filters">
        <div class="filter" data-tag="cheap">üí∏ Pas cher</div>
        <div class="filter" data-tag="ambiance">üé∂ Ambiance</div>
        <div class="filter" data-tag="terrasse">‚òÄÔ∏è Terrasse</div>
        <div class="filter" data-tag="cocktails">üç∏ Cocktails</div>
        <div class="filter" data-tag="happy">üî• Happy Hour</div>
      </div>

      <div class="results" id="results"></div>
    </div>
  </main>

  <div class="nav">
    <button class="active">üè†<span>Accueil</span></button>
    <button>üìç<span>Carte</span></button>
    <button>‚≠ê<span>Favoris</span></button>
    <button>‚öôÔ∏è<span>Filtres</span></button>
  </div>

  <!-- Loader -->
  <div id="overlay" class="overlay"><div class="spinner"></div></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== Map init (dark tiles) =====
    const map = L.map('map').setView([48.8566,2.3522], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);

    // ===== UI refs =====
    const addr1 = document.getElementById('addr1');
    const addr2 = document.getElementById('addr2');
    const addr3 = document.getElementById('addr3');
    const useGPSBtn = document.getElementById('useGPS');
    const findBtn = document.getElementById('find');
    const resultsEl = document.getElementById('results');
    const filtersEl = document.getElementById('filters');
    const statusEl = document.getElementById('status');
    const overlay = document.getElementById('overlay');

    let currentFilters = new Set();
    let originMarkers = [], barMarkers = [];

    // ===== Helpers =====
    function setStatus(t){ statusEl.textContent = t || ''; }
    function showLoad(v){ overlay.classList.toggle('show', !!v); }
    function clearMarkers(){ originMarkers.forEach(m=>m.remove()); barMarkers.forEach(m=>m.remove()); originMarkers=[]; barMarkers=[]; }

    // Photon geocoding (OSM)
    async function photonSuggest(q, limit=1){
      const url = 'https://photon.komoot.io/api/?q='+encodeURIComponent(q)+'&lang=fr&limit='+limit;
      const r = await fetch(url); if(!r.ok) throw new Error('Geocoding error');
      const j = await r.json();
      return (j.features||[]).map(f=>({ label:q, lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0] }));
    }
    async function geocodeOne(s){
      const t = s?.trim(); if(!t) throw new Error('Adresse vide');
      const res = await photonSuggest(t, 1);
      if(!res.length) throw new Error('Adresse introuvable: '+t);
      return res[0];
    }

    // Weiszfeld (geometric median)
    function weiszfeld(points, maxIter=100, eps=1e-7){
      let x = points.reduce((s,p)=>s+p.lon,0)/points.length;
      let y = points.reduce((s,p)=>s+p.lat,0)/points.length;
      for(let k=0;k<maxIter;k++){
        let nx=0, ny=0, den=0;
        for(const p of points){
          const dx=x-p.lon, dy=y-p.lat;
          const d=Math.hypot(dx,dy)||eps;
          nx += p.lon/d; ny += p.lat/d; den += 1/d;
        }
        nx/=den; ny/=den;
        if(Math.hypot(nx-x,ny-y)<eps) return {lat:ny,lon:nx};
        x=nx; y=ny;
      }
      return {lat:y,lon:x};
    }

    // Overpass query (with soft filter hints)
    function overpassQuery(lat, lon, radius, want){
      // Base: bars/pubs/caf√©s
      let filter = 'node["amenity"~"bar|pub|cafe"]';
      // Soft tag hints: we‚Äôll still post-filter client side
      if(want.has('terrasse')) filter += '["outdoor_seating"~"yes|true",i]';
      if(want.has('cocktails')) filter += '["cocktail"~"yes|true",i]';
      if(want.has('happy')) filter += '["happy_hours"~".*",i]';
      return `[out:json][timeout:25];${filter}(around:${radius},${lat},${lon});out center 80;`;
    }

    async function fetchOverpassBars(lat, lon, want=new Set()){
      let q = overpassQuery(lat,lon,900,want);
      let r = await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q});
      if(!r.ok){ // retry once with larger radius
        q = overpassQuery(lat,lon,1200,want);
        r = await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q});
      }
      const j = await r.json();
      let elems = (j.elements||[]).map(e=>({
        name: (e.tags?.name)||'Bar sans nom',
        lat: e.lat, lon: e.lon, tags: e.tags||{}
      }));
      // If too few, broaden without strict tags:
      if(elems.length < 12 && want.size){
        const q2 = `[out:json][timeout:25];node["amenity"~"bar|pub|cafe"](around:1200,${lat},${lon});out center 80;`;
        const r2 = await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q2});
        const j2 = await r2.json();
        const extra = (j2.elements||[]).map(e=>({name:e.tags?.name||'Bar sans nom',lat:e.lat,lon:e.lon,tags:e.tags||{}}));
        // Merge (avoid dup by coords approx)
        const key = s => `${s.lat.toFixed(5)}:${s.lon.toFixed(5)}:${s.name}`;
        const seen = new Set(elems.map(s=>key(s)));
        for(const x of extra){ const k=key(x); if(!seen.has(k)) elems.push(x); }
      }
      return elems.slice(0,50);
    }

    // OSRM table (foot)
    async function osrmTable(origins, dests){
      const coords = [...origins, ...dests].map(p=>`${p.lon},${p.lat}`).join(';');
      const sources = origins.map((_,i)=>i).join(';');
      const url = `https://router.project-osrm.org/table/v1/foot/${coords}?sources=${sources}`;
      const r = await fetch(url); if(!r.ok) throw new Error('OSRM error');
      return r.json();
    }

    // Scoring with soft bonuses from filters
    function scoreBars(origins, bars, durations, want){
      const srcCount = origins.length;
      const mat = durations.map(row => row.slice(srcCount));
      return bars.map((b, j)=>{
        const times = mat.map(row => Math.round((row[j]||0)/60));
        const finite = times.map(t=>Number.isFinite(t)?t:999);
        let max = Math.max(...finite);
        let mean = finite.reduce((a,b)=>a+b,0)/finite.length;

        // Soft bonuses/penalties based on tags (heuristics)
        const tags = (b.tags||{});
        let bonus = 0;
        if(want.has('terrasse') && (tags.outdoor_seating==='yes' || /terrace|terrasse/i.test(tags.name||''))) bonus -= 2;
        if(want.has('cocktails') && (/cocktail/i.test(tags.name||'') || tags.cocktail==='yes')) bonus -= 2;
        if(want.has('happy') && (tags.happy_hours || /happy/i.test(tags.name||''))) bonus -= 2;
        if(want.has('ambiance') && (/jazz|vinyle|speakeasy|calme|lounge/i.test((tags.description||'')+(tags.name||'')))) bonus -= 1;
        if(want.has('cheap') && (/happy|promo|etudiant|√©tudiant/i.test((tags.description||'')+(tags.name||'')))) bonus -= 1;

        const score = max + 0.3*std(finite) + bonus;
        return { place:b, metrics:{times:finite, max, mean, score} };
      }).sort((a,b)=> a.metrics.score - b.metrics.score || a.metrics.mean - b.metrics.mean)
        .slice(0,4);
    }
    function std(arr){ const m=arr.reduce((a,b)=>a+b,0)/arr.length; return Math.sqrt(arr.map(x=>(x-m)**2).reduce((a,b)=>a+b,0)/arr.length) }

    function render(origins, top){
      resultsEl.innerHTML=''; clearMarkers();
      // origins
      origins.forEach((o,i)=>{
        originMarkers.push(L.marker([o.lat,o.lon]).addTo(map).bindPopup(`Origine ${i+1}<br>${o.label||o.lat.toFixed(4)+', '+o.lon.toFixed(4)}`));
      });
      // bars + list
      top.forEach((r,idx)=>{
        const m = L.marker([r.place.lat,r.place.lon]).addTo(map)
          .bindPopup(`<b>${idx+1}. ${r.place.name}</b><br>Temps (min): ${r.metrics.times.join(' / ')}<br><a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${r.place.lat},${r.place.lon}">Ouvrir dans Google Maps</a>`);
        barMarkers.push(m);

        const badgeCls = r.metrics.max<=25?'ok':(r.metrics.max<=35?'warn':'');
        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <h3>${idx+1}. ${r.place.name}</h3>
              <small>${r.metrics.times.join(' / ')} min ‚Äî moyenne: ${r.metrics.mean.toFixed(1)} min</small>
            </div>
            <span class="badge ${badgeCls}">${r.metrics.max} min max</span>
          </div>
          <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
            <a class="badge" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${r.place.lat},${r.place.lon}">Itin√©raire</a>
          </div>`;
        resultsEl.appendChild(card);
      });

      const all = [...origins.map(o=>[o.lat,o.lon]), ...top.map(t=>[t.place.lat,t.place.lon])];
      if(all.length) map.fitBounds(all, {padding:[40,40]});
    }

    // Filters toggle
    filtersEl.querySelectorAll('.filter').forEach(el=>{
      el.onclick=()=>{
        el.classList.toggle('active');
        if(el.classList.contains('active')) currentFilters.add(el.dataset.tag);
        else currentFilters.delete(el.dataset.tag);
      };
    });

    // GPS insertion as an origin (prepends)
    useGPSBtn.onclick=()=>{
      if(!navigator.geolocation){ alert("La g√©olocalisation n'est pas disponible."); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude:lat, longitude:lon} = pos.coords;
        // Place a marker immediately (visual)
        L.marker([lat,lon]).addTo(map).bindPopup('Ma position');
        map.setView([lat,lon], 13);
        // Put coords text into an input for geocoding step (keeps pipeline simple)
        addr3.value = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      }, ()=> alert("Impossible d'obtenir la position."));
    };

    // Parse "lat, lon" input
    function parseLatLon(s){
      const m = s.trim().match(/^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/);
      if(!m) return null;
      return { lat: parseFloat(m[1]), lon: parseFloat(m[3]), label:'Ma position' };
    }

    // Main flow
    findBtn.onclick = async ()=>{
      try{
        const raw = [addr1.value, addr2.value, addr3.value].map(v=>v.trim()).filter(Boolean);
        if(raw.length<2) return alert('Ajoute au moins 2 adresses.');
        setStatus('G√©ocodage des adresses‚Ä¶'); showLoad(true); findBtn.disabled=true;

        // Geocode (supports "lat, lon" direct)
        const origins = [];
        for(const s of raw){
          const parsed = parseLatLon(s);
          origins.push(parsed ? parsed : await geocodeOne(s));
        }

        setStatus('Calcul du milieu √©quitable‚Ä¶');
        const pivot = weiszfeld(origins);

        setStatus('Recherche des bars autour‚Ä¶');
        let bars = await fetchOverpassBars(pivot.lat, pivot.lon, currentFilters);

        if(!bars.length){ setStatus('Aucun bar trouv√©.'); showLoad(false); findBtn.disabled=false; return; }

        setStatus('Calcul des temps √† pied‚Ä¶');
        const table = await osrmTable(origins, bars);

        setStatus('Classement des r√©sultats‚Ä¶');
        const top = scoreBars(origins, bars, table.durations, currentFilters);

        setStatus(''); showLoad(false); findBtn.disabled=false;
        render(origins, top);
      }catch(e){
        console.error(e);
        alert('Erreur : ' + (e.message || e));
        setStatus(''); showLoad(false); findBtn.disabled=false;
      }
    };

    // Prefill examples for quick try
    addr1.value = 'Bastille, Paris';
    addr2.value = 'Porte de Clignancourt, Paris';
    addr3.value = 'Jardin du Luxembourg, Paris';
  </script>
</body>
</html>
