<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>PointBar ‚Äî On se retrouve √† mi-chemin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root {
      --bg: #0e1116; --panel:#101522; --panel2:#0c1020; --fg:#e7eaf0; --muted:#9aa4b2;
      --line:#232a3d; --accent:#67f0b3; --accent-ink:#0b1320; --warn:#f0d46e; --ok:#6ef0b3;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    a { color:#8ad6ff; text-decoration:none; }
    .app { display:grid; grid-template-columns: 380px 1fr; height:100%; }
    aside { padding:14px; overflow:auto; border-right:1px solid var(--line); background:var(--panel); }
    header h1 { margin:0; font-size:22px; letter-spacing:.2px; }
    header small { color:var(--muted); }
    .card { border:1px solid var(--line); background:var(--panel2); border-radius:14px; padding:10px; margin-bottom:10px; }
    .row { display:flex; gap:8px; align-items:center; }
    .stack { display:flex; flex-direction:column; gap:8px; }
    input[type="text"] {
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid #26304a; background:#0c1223; color:var(--fg);
    }
    button {
      background:var(--accent); color:var(--accent-ink); border:0; padding:12px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    button.secondary { background:#1b243a; color:#d9e0ef; border:1px solid var(--line); }
    button.ghost { background:transparent; color:#c9d2e3; border:1px dashed var(--line); }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .btnbar { display:flex; gap:8px; flex-wrap:wrap; }
    .chip { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); font-size:12px; }
    #map { height:100%; width:100%; }
    ul.list { list-style:none; margin:8px 0 0 0; padding:0; }
    ul.list li { margin:0 0 10px 0; padding:10px; border:1px solid var(--line); border-radius:12px; background:#0f1426; }
    .metric { font-size:12px; color:var(--muted); }
    .badge { border-radius:8px; padding:2px 8px; font-size:12px; }
    .ok { color:var(--ok); } .warn { color:var(--warn); }
    .muted { color:var(--muted); }

    /* Loader overlay */
    .overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter:saturate(120%) blur(2px); }
    .overlay.show { display:flex; }
    .spinner { width:42px; height:42px; border:4px solid #2a3553; border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Mobile */
    @media (max-width: 860px) {
      .app { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      aside { border-right:none; border-bottom:1px solid var(--line); }
      .btnbar { gap:6px; }
      button { flex:1; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside>
    <header class="stack" style="gap:4px">
      <h1>PointBar</h1>
      <small>On se retrouve √† mi-chemin.</small>
    </header>

    <div id="origins"></div>

    <div class="btnbar" style="margin:8px 0 12px 0">
      <button id="addOrigin" class="secondary">+ Ajouter une adresse</button>
      <button id="useGPS" class="ghost">üìç Use my location</button>
      <button id="findBtn">Trouver 3 bars √©quitables</button>
    </div>

    <div id="status" class="muted"></div>

    <div class="row" style="justify-content:space-between; align-items:center; margin-top:12px">
      <h3 style="margin:0">R√©sultats</h3>
      <button id="shareBtn" class="secondary" title="Partager">Partager</button>
    </div>
    <ul id="results" class="list"></ul>

    <div class="card muted" style="margin-top:12px">
      <b>Comment √ßa marche ?</b><br/>
      ‚Ä¢ Autocomplete (Photon / OSM) ‚Äî tape naturellement ¬´ Bastille, Paris ¬ª. <br/>
      ‚Ä¢ Milieu √©quitable (m√©diane g√©om√©trique).<br/>
      ‚Ä¢ Bars via Overpass (OSM).<br/>
      ‚Ä¢ Temps √† pied via OSRM ‚Äútable‚Äù.<br/>
      ‚Ä¢ Classement : on minimise le <i>temps max</i> (√©quit√©).
    </div>
  </aside>

  <div id="map"></div>
</div>

<!-- Loader Overlay -->
<div id="overlay" class="overlay"><div class="spinner"></div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  // ====== UI refs ======
  const originsDiv = document.getElementById('origins');
  const resultsEl  = document.getElementById('results');
  const statusEl   = document.getElementById('status');
  const addBtn     = document.getElementById('addOrigin');
  const findBtn    = document.getElementById('findBtn');
  const shareBtn   = document.getElementById('shareBtn');
  const overlay    = document.getElementById('overlay');
  const useGPSBtn  = document.getElementById('useGPS');

  let originRows = []; // {wrap,input,lat,lon,label}
  let lastTop    = []; // r√©sultats courants

  // ====== Map ======
  const map = L.map('map', { zoomControl: true }).setView([48.8566, 2.3522], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              { attribution: '&copy; OpenStreetMap' }).addTo(map);
  let originMarkers = [], barMarkers = [];

  function clearMarkers(){
    originMarkers.forEach(m => m.remove());
    barMarkers.forEach(m => m.remove());
    originMarkers = []; barMarkers = [];
  }

  // ====== Helpers ======
  function showLoad(v){ overlay.classList.toggle('show', !!v); }
  function setStatus(msg=''){ statusEl.textContent = msg||''; }

  async function photonSuggest(q, limit=5){
    const url = 'https://photon.komoot.io/api/?q=' + encodeURIComponent(q) + '&lang=fr&limit=' + limit;
    const r = await fetch(url); if(!r.ok) return [];
    const j = await r.json(); return (j.features||[]).map(f => ({
      label: f.properties?.name + (f.properties?.city ? ', ' + f.properties.city : ''),
      lat: f.geometry.coordinates[1],
      lon: f.geometry.coordinates[0]
    }));
  }

  async function geocodeOne(raw){
    // If row already has lat/lon (GPS) return it
    if (raw && typeof raw.lat === 'number' && typeof raw.lon === 'number') return raw;
    const sugg = await photonSuggest(raw, 1);
    if(!sugg.length) throw new Error('Adresse introuvable : ' + raw);
    return { label: raw, lat: sugg[0].lat, lon: sugg[0].lon };
  }

  function weiszfeld(points, maxIter=100, eps=1e-7){
    let x = points.reduce((s,p)=>s+p.lon,0)/points.length;
    let y = points.reduce((s,p)=>s+p.lat,0)/points.length;
    for(let k=0;k<maxIter;k++){
      let nx=0, ny=0, den=0;
      for(const p of points){
        const dx=x-p.lon, dy=y-p.lat;
        const d=Math.hypot(dx,dy)||eps;
        nx += p.lon/d; ny += p.lat/d; den += 1/d;
      }
      nx/=den; ny/=den;
      if(Math.hypot(nx-x,ny-y)<eps) return {lat:ny,lon:nx};
      x=nx; y=ny;
    }
    return {lat:y,lon:x};
  }

  async function fetchOverpassBars(lat, lon, radius=900){
    const q = `[out:json][timeout:25];
      node["amenity"~"bar|pub|cafe"](around:${radius},${lat},${lon});
      out center 60;`;
    const r = await fetch('https://overpass-api.de/api/interpreter', {method:'POST', body:q});
    if(!r.ok) throw new Error('Overpass error');
    const j = await r.json();
    return (j.elements||[]).map(e => ({ name: e.tags?.name || 'Bar sans nom', lat:e.lat, lon:e.lon }));
  }

  async function osrmTable(origins, dests){
    const coords = [...origins, ...dests].map(p=>`${p.lon},${p.lat}`).join(';');
    const sources = origins.map((_,i)=>i).join(';');
    const url = `https://router.project-osrm.org/table/v1/foot/${coords}?sources=${sources}`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('OSRM error');
    return r.json();
  }

  function scoreBars(origins, bars, durations){
    const srcCount = origins.length;
    const mat = durations.map(row => row.slice(srcCount));
    return bars.map((b, j)=> {
      const times = mat.map(row => Math.round((row[j]||0)/60));
      const finite = times.map(t => Number.isFinite(t) ? t : 999);
      const max = Math.max(...finite);
      const mean = finite.reduce((a,b)=>a+b,0)/finite.length;
      const std = Math.sqrt(finite.map(t => (t-mean)**2).reduce((a,b)=>a+b,0)/finite.length);
      return { place:b, metrics:{times, max, mean, std, score:max} };
    }).sort((a,b)=>
      a.metrics.score - b.metrics.score ||
      a.metrics.mean  - b.metrics.mean  ||
      a.metrics.std   - b.metrics.std
    ).slice(0,3);
  }

  function fitBoundsFor(origins, bars){
    const latlngs = [...origins.map(o=>[o.lat,o.lon]), ...bars.map(b=>[b.place.lat,b.place.lon])];
    if(latlngs.length) map.fitBounds(latlngs, {padding:[40,40]});
  }

  function renderResults(top, origins){
    resultsEl.innerHTML = '';
    clearMarkers();

    origins.forEach((o,i)=>{
      const m = L.marker([o.lat,o.lon]).addTo(map).bindPopup(`Origine ${i+1}<br>${o.label||`${o.lat.toFixed(4)}, ${o.lon.toFixed(4)}`}`);
      originMarkers.push(m);
    });

    top.forEach((r,idx)=>{
      const m = L.marker([r.place.lat, r.place.lon]).addTo(map)
        .bindPopup(`<b>${idx+1}. ${r.place.name}</b><br>Temps (min): ${r.metrics.times.join(' / ')}<br>
        <a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${r.place.lat},${r.place.lon}">Ouvrir dans Google Maps</a>`);
      barMarkers.push(m);

      const cls = r.metrics.max <= 25 ? 'ok' : (r.metrics.max <= 35 ? 'warn' : '');
      const li = document.createElement('li');
      li.innerHTML = `<div class="row" style="justify-content:space-between; gap:8px">
        <div>
          <div style="font-weight:700">${idx+1}. ${r.place.name}</div>
          <div class="metric">(${r.metrics.times.join(' / ')}) ‚Äî moyenne: ${r.metrics.mean.toFixed(1)} min</div>
        </div>
        <div class="badge ${cls}" style="border:1px solid var(--line)">${r.metrics.max} min max</div>
      </div>
      <div class="row" style="margin-top:8px; gap:8px">
        <a class="chip" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${r.place.lat},${r.place.lon}">Itin√©raire</a>
        <button class="secondary" onclick="shareOne(${r.place.lat},${r.place.lon}, '${encodeURIComponent(r.place.name)}')">Partager ce bar</button>
      </div>`;
      resultsEl.appendChild(li);
    });

    fitBoundsFor(origins, top);
    lastTop = top;
  }

  // ====== Origins UI ======
  function addOriginRow(defaultText=''){
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.innerHTML = `
      <div class="stack">
        <input type="text" placeholder="Adresse (ex: Bastille, Paris)" value="${defaultText}">
        <div class="row" style="gap:6px">
          <button class="ghost remove">Supprimer</button>
        </div>
        <datalist></datalist>
      </div>`;
    originsDiv.appendChild(wrap);

    const input = wrap.querySelector('input');
    const remove = wrap.querySelector('.remove');
    const dl     = wrap.querySelector('datalist');
    const id     = 'dl-' + Math.random().toString(36).slice(2);
    input.setAttribute('list', id);
    dl.id = id;

    input.addEventListener('input', async (e)=>{
      const q = e.target.value.trim();
      if(q.length < 3) { dl.innerHTML=''; return; }
      try {
        const sugg = await photonSuggest(q, 5);
        dl.innerHTML = sugg.map(s => `<option value="${s.label}"></option>`).join('');
      } catch {}
    });

    remove.onclick = () => { wrap.remove(); originRows = originRows.filter(r => r.wrap !== wrap); };

    originRows.push({wrap, input, lat:null, lon:null, label: defaultText});
  }

  // Default three (diff√©rentes de la d√©mo pr√©c√©dente)
  addOriginRow('Bastille, Paris');
  addOriginRow('Porte de Clignancourt, Paris');
  addOriginRow('Jardin du Luxembourg, Paris');

  addBtn.onclick = () => addOriginRow('');

  // ====== GPS button ======
  useGPSBtn.onclick = () => {
    if(!navigator.geolocation){ alert("La g√©olocalisation n'est pas disponible."); return; }
    navigator.geolocation.getCurrentPosition((pos)=>{
      const { latitude:lat, longitude:lon } = pos.coords;
      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.innerHTML = `
        <div class="stack">
          <div class="row" style="justify-content:space-between"><b>Ma position actuelle</b><span class="chip">GPS</span></div>
          <div class="row" style="gap:6px"><button class="ghost remove">Supprimer</button></div>
        </div>`;
      originsDiv.prepend(wrap);
      const remove = wrap.querySelector('.remove');
      const row = { wrap, input:null, lat, lon, label:'Ma position' };
      remove.onclick = () => { wrap.remove(); originRows = originRows.filter(r => r !== row); };
      originRows.unshift(row);
      L.marker([lat,lon]).addTo(map).bindPopup('Ma position');
      map.setView([lat,lon], 13);
    }, ()=> alert("Impossible d'obtenir la position."));
  };

  // ====== Main flow ======
  async function run(){
    try{
      setStatus('Pr√©paration‚Ä¶'); showLoad(true); findBtn.disabled = true;
      // Collect & geocode
      const addr = [];
      for(const r of originRows){
        if (r.input) {
          const t = r.input.value.trim();
          if(t) addr.push(t);
        } else if (typeof r.lat === 'number' && typeof r.lon === 'number') {
          addr.push({ label: r.label, lat:r.lat, lon:r.lon });
        }
      }
      if(addr.length < 2) { showLoad(false); findBtn.disabled=false; return alert('Ajoute au moins 2 adresses.'); }

      setStatus('G√©ocodage des adresses‚Ä¶');
      const origins = [];
      for(const a of addr){ origins.push(await geocodeOne(a)); }

      // Pivot + bars
      setStatus('Recherche des bars proches du milieu‚Ä¶');
      const pivot = weiszfeld(origins);
      let bars = await fetchOverpassBars(pivot.lat, pivot.lon, 900);
      if(bars.length < 15) bars = await fetchOverpassBars(pivot.lat, pivot.lon, 1200);
      if(!bars.length){ setStatus('Aucun bar trouv√©.'); showLoad(false); findBtn.disabled=false; return; }

      // Durations + scoring
      setStatus('Calcul des temps √† pied‚Ä¶');
      const table = await osrmTable(origins, bars);
      const top = scoreBars(origins, bars, table.durations);

      setStatus(''); showLoad(false); findBtn.disabled=false;
      renderResults(top, origins);
    }catch(e){
      console.error(e);
      setStatus('Erreur : ' + (e.message||e)); showLoad(false); findBtn.disabled=false;
      alert('Erreur: ' + (e.message||e));
    }
  }
  findBtn.onclick = run;

  // ====== Share buttons ======
  function shareTextForTop(){
    if(!lastTop.length) return 'PointBar ‚Äî On se retrouve √† mi-chemin.';
    const best = lastTop[0];
    const gmap = `https://www.google.com/maps/search/?api=1&query=${best.place.lat},${best.place.lon}`;
    return `On se retrouve ici ? ${best.place.name} (${best.metrics.max} min max chacun)\n${gmap}`;
  }
  window.shareOne = function(lat, lon, nameEnc){
    const name = decodeURIComponent(nameEnc);
    const txt = `On se retrouve ici ? ${name}\nhttps://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
    if(navigator.share){ navigator.share({ text: txt }).catch(()=>{}); }
    else { window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank'); }
  };
  shareBtn.onclick = ()=>{
    const txt = shareTextForTop();
    if(navigator.share){ navigator.share({ text: txt }).catch(()=>{}); }
    else { window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank'); }
  };
</script>
</body>
</html>
